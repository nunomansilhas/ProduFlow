<!DOCTYPE html>
<html lang="pt" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock - ProduFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard"><i class="fas fa-industry me-2"></i>ProduFlow</a>
            <div class="d-flex align-items-center ms-auto">
                <a href="#" class="btn btn-link text-light position-relative me-3"><i class="fas fa-bell"></i><span class="badge bg-danger rounded-pill" id="alertas-badge" style="display: none;">0</span></a>
                <div class="dropdown">
                    <button class="btn btn-link text-light dropdown-toggle text-decoration-none" type="button" data-bs-toggle="dropdown"><i class="fas fa-user-circle me-1"></i><span id="user-nome">Utilizador</span></button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark"><li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li></ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="wrapper">
        <nav class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="sidebar-heading">Catalogo</li>
                <li class="nav-item"><a class="nav-link" href="/categorias"><i class="fas fa-tags"></i> Categorias</a></li>
                <li class="nav-item"><a class="nav-link" href="/produtos"><i class="fas fa-boxes"></i> Produtos</a></li>
                <li class="nav-item"><a class="nav-link" href="/servicos"><i class="fas fa-truck"></i> Servicos Externos</a></li>
                <li class="sidebar-heading">Stock</li>
                <li class="nav-item"><a class="nav-link" href="/fornecedores"><i class="fas fa-building"></i> Fornecedores</a></li>
                <li class="nav-item"><a class="nav-link" href="/materias"><i class="fas fa-cubes"></i> Materias-Primas</a></li>
                <li class="nav-item"><a class="nav-link active" href="/stock"><i class="fas fa-warehouse"></i> Stock</a></li>
                <li class="sidebar-heading">Producao</li>
                <li class="nav-item"><a class="nav-link" href="/estacoes"><i class="fas fa-toolbox"></i> Estacoes</a></li>
                <li class="nav-item"><a class="nav-link" href="/ordens"><i class="fas fa-clipboard-list"></i> Ordens</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Gestao de Stock</h1>
                <a href="/stock/movimentos" class="btn btn-outline-light"><i class="fas fa-history me-2"></i>Historico</a>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <select class="form-select" id="filtro-estado" onchange="carregarStock()">
                        <option value="">Todos</option>
                        <option value="negativo">Stock Negativo</option>
                        <option value="baixo">Stock Baixo</option>
                        <option value="ok">Stock OK</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="filtro-pesquisa" placeholder="Pesquisar..." oninput="filtrarStock()">
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Codigo</th>
                                    <th>Material</th>
                                    <th>Quantidade</th>
                                    <th>Minimo</th>
                                    <th>Estado</th>
                                    <th>Localizacao</th>
                                    <th width="200">Acoes</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table">
                                <tr><td colspan="7" class="text-center text-muted py-4">A carregar...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Movimento -->
    <div class="modal fade" id="movimento-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="movimento-titulo">Movimento de Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="movimento-form">
                        <input type="hidden" id="mov-materia-id">
                        <input type="hidden" id="mov-tipo">
                        <div class="mb-3">
                            <label class="form-label">Material</label>
                            <input type="text" class="form-control" id="mov-material-nome" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantidade *</label>
                            <input type="number" class="form-control" id="mov-quantidade" step="0.01" min="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo</label>
                            <input type="text" class="form-control" id="mov-motivo" placeholder="Opcional">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarMovimento()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajuste -->
    <div class="modal fade" id="ajuste-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Ajuste de Inventario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ajuste-form">
                        <input type="hidden" id="ajuste-materia-id">
                        <div class="mb-3">
                            <label class="form-label">Material</label>
                            <input type="text" class="form-control" id="ajuste-material-nome" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Stock Atual</label>
                            <input type="text" class="form-control" id="ajuste-atual" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nova Quantidade *</label>
                            <input type="number" class="form-control" id="ajuste-quantidade" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo *</label>
                            <input type="text" class="form-control" id="ajuste-motivo" value="Acerto de inventario" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="guardarAjuste()">Ajustar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let stockData = [];

        async function carregarStock() {
            try {
                const estado = document.getElementById('filtro-estado').value;
                const url = estado ? `/stock?estado=${estado}` : '/stock';
                stockData = await api.get(url);
                renderizarTabela();
            } catch (error) {
                mostrarErro('Erro ao carregar stock');
            }
        }

        function filtrarStock() {
            renderizarTabela();
        }

        function renderizarTabela() {
            const pesquisa = document.getElementById('filtro-pesquisa').value.toLowerCase();
            const filtrados = stockData.filter(s =>
                s.nome.toLowerCase().includes(pesquisa) ||
                (s.codigo && s.codigo.toLowerCase().includes(pesquisa))
            );

            const tbody = document.getElementById('stock-table');
            if (filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Nenhum item encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = filtrados.map(s => {
                const estadoClass = s.estado_stock === 'negativo' ? 'bg-danger' :
                                   s.estado_stock === 'baixo' ? 'bg-warning text-dark' : 'bg-success';
                const qtyClass = s.estado_stock === 'negativo' ? 'text-danger fw-bold' :
                                s.estado_stock === 'baixo' ? 'text-warning' : '';
                return `
                    <tr>
                        <td><code>${s.codigo || '-'}</code></td>
                        <td>${s.nome}</td>
                        <td class="${qtyClass}">${formatarNumero(s.quantidade)} ${s.unidade}</td>
                        <td>${s.stock_minimo} ${s.unidade}</td>
                        <td><span class="badge ${estadoClass}">${s.estado_stock === 'negativo' ? 'Negativo' : s.estado_stock === 'baixo' ? 'Baixo' : 'OK'}</span></td>
                        <td>${s.localizacao || '-'}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-success" onclick="abrirMovimento(${s.material_id}, 'entrada', '${s.nome}')"><i class="fas fa-plus"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="abrirMovimento(${s.material_id}, 'saida', '${s.nome}')"><i class="fas fa-minus"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="abrirAjuste(${s.material_id}, '${s.nome}', ${s.quantidade}, '${s.unidade}')"><i class="fas fa-sync"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function abrirMovimento(materiaId, tipo, nome) {
            document.getElementById('mov-materia-id').value = materiaId;
            document.getElementById('mov-tipo').value = tipo;
            document.getElementById('mov-material-nome').value = nome;
            document.getElementById('movimento-titulo').textContent = tipo === 'entrada' ? 'Entrada de Stock' : 'Saida de Stock';
            document.getElementById('mov-quantidade').value = '';
            document.getElementById('mov-motivo').value = '';
            abrirModal('movimento-modal');
        }

        async function guardarMovimento() {
            const data = {
                materia_id: document.getElementById('mov-materia-id').value,
                tipo: document.getElementById('mov-tipo').value,
                quantidade: parseFloat(document.getElementById('mov-quantidade').value),
                motivo: document.getElementById('mov-motivo').value || null
            };

            if (!data.quantidade || data.quantidade <= 0) {
                mostrarErro('Quantidade invalida');
                return;
            }

            try {
                await api.post('/stock/movimento', data);
                mostrarSucesso('Movimento registado');
                fecharModal('movimento-modal');
                carregarStock();
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        function abrirAjuste(materiaId, nome, quantidade, unidade) {
            document.getElementById('ajuste-materia-id').value = materiaId;
            document.getElementById('ajuste-material-nome').value = nome;
            document.getElementById('ajuste-atual').value = `${quantidade} ${unidade}`;
            document.getElementById('ajuste-quantidade').value = quantidade;
            document.getElementById('ajuste-motivo').value = 'Acerto de inventario';
            abrirModal('ajuste-modal');
        }

        async function guardarAjuste() {
            const data = {
                materia_id: document.getElementById('ajuste-materia-id').value,
                quantidade: parseFloat(document.getElementById('ajuste-quantidade').value),
                motivo: document.getElementById('ajuste-motivo').value
            };

            try {
                await api.post('/stock/ajuste', data);
                mostrarSucesso('Ajuste registado');
                fecharModal('ajuste-modal');
                carregarStock();
            } catch (error) {
                mostrarErro(error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', carregarStock);
    </script>
</body>
</html>
