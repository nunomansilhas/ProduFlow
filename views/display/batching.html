<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Corte</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #fff;
            color: #000;
            font-family: "Courier New", monospace;
            font-size: 15px;
            line-height: 1.5;
        }

        header {
            border-bottom: 3px solid #000;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        header .meta {
            font-size: 0.85rem;
            text-align: right;
            color: #555;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .actions button, .actions a {
            background: #000;
            color: #fff;
            border: none;
            padding: 0.4rem 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: none;
        }

        main {
            padding: 1.5rem;
        }

        .material-block {
            margin-bottom: 2rem;
            break-inside: avoid;
        }

        .material-header {
            background: #000;
            color: #fff;
            padding: 0.6rem 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-header .total {
            font-size: 0.9rem;
            font-weight: 400;
        }

        .stock-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        .stock-badge.ok {
            background: #d4edda;
            color: #155724;
        }

        .stock-badge.low {
            background: #fff3cd;
            color: #856404;
        }

        .stock-badge.out {
            background: #f8d7da;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid #000;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #555;
        }

        td {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #ddd;
        }

        tr:last-child td {
            border-bottom: 2px solid #000;
        }

        .qty {
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            min-width: 60px;
        }

        .medida {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .notas {
            font-size: 0.8rem;
            color: #555;
            font-style: italic;
        }

        .empty {
            text-align: center;
            padding: 4rem;
            color: #999;
            font-size: 1.2rem;
        }

        .check {
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            display: inline-block;
        }

        /* Print */
        @media print {
            .actions { display: none; }
            body { font-size: 13px; }
            main { padding: 0.5rem; }
            .material-block { margin-bottom: 1.5rem; }
        }

        @media (max-width: 600px) {
            header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .actions { margin-left: 0; }
            td, th { padding: 0.4rem 0.5rem; }
            .qty { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1 id="title">Lista de Corte</h1>
            <div class="meta" id="meta"></div>
        </div>
        <div class="actions">
            <button onclick="window.print()">IMPRIMIR</button>
            <button onclick="location.reload()">ATUALIZAR</button>
            <a href="/display">VOLTAR</a>
        </div>
    </header>

    <main id="content">
        <div class="empty">A carregar...</div>
    </main>

    <script>
        const estacaoId = window.location.pathname.split('/').pop();

        async function load() {
            let estacao = { nome: 'Estacao' };
            try {
                const r = await fetch(`/api/display/estacoes/${estacaoId}`);
                if (r.ok) estacao = await r.json();
            } catch (e) {}

            document.getElementById('title').textContent =
                `Lista de Corte - ${estacao.nome}`;
            document.getElementById('meta').textContent =
                new Date().toLocaleDateString('pt-PT', {
                    weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric'
                }) + '  ' + new Date().toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });

            let materiais = [];
            try {
                const r = await fetch(`/api/display/estacoes/${estacaoId}/materiais`);
                if (r.ok) materiais = await r.json();
            } catch (e) {}

            render(materiais);
        }

        function fmt(n) {
            if (n === Math.floor(n)) return n.toString();
            return n.toFixed(2).replace('.', ',');
        }

        function render(materiais) {
            const el = document.getElementById('content');

            if (!materiais || materiais.length === 0) {
                el.innerHTML = '<div class="empty">Sem materiais para processar nesta estacao.</div>';
                return;
            }

            let html = '';

            for (const mat of materiais) {
                const ratio = mat.stock / mat.total;
                const stockClass = ratio >= 1 ? 'ok' : ratio > 0 ? 'low' : 'out';
                const stockLabel = ratio >= 1 ? 'OK' : ratio > 0 ? 'BAIXO' : 'SEM STOCK';

                html += `
                    <div class="material-block">
                        <div class="material-header">
                            <span>
                                ${mat.material}
                                ${mat.codigo ? ` [${mat.codigo}]` : ''}
                                <span class="stock-badge ${stockClass}">${stockLabel} ${fmt(mat.stock)} ${mat.unidade}</span>
                            </span>
                            <span class="total">TOTAL: ${fmt(mat.total)} ${mat.unidade}</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:50px;"></th>
                                    <th>Pecas</th>
                                    <th>Medida</th>
                                    <th>Subtotal</th>
                                    <th>Para</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mat.cortes.map(c => `
                                    <tr>
                                        <td><span class="check"></span></td>
                                        <td class="qty">${c.pecas}</td>
                                        <td class="medida">${fmt(c.medida)} ${mat.unidade}</td>
                                        <td>${fmt(c.subtotal)} ${mat.unidade}</td>
                                        <td>${c.produto}</td>
                                        <td class="notas">${c.notas || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            el.innerHTML = html;
        }

        load();
        setInterval(load, 60000);
    </script>
</body>
</html>
