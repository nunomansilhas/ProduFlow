<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProduFlow</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg: #000;
            --surface: #111;
            --border: #222;
            --text: #fff;
            --muted: #666;
            --accent: #0d6efd;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation;
        }

        /* Layout principal */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header compacto */
        .header {
            background: var(--accent);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .station-name {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clock {
            font-size: 1.25rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }

        /* Conteúdo principal */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }

        /* Card da ordem atual */
        .order-card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--border);
            min-height: 0;
        }

        .order-card.has-order {
            border-color: var(--accent);
        }

        /* Header da ordem */
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .order-id {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 700;
            color: var(--accent);
            line-height: 1.1;
        }

        .order-product {
            font-size: clamp(1rem, 3vw, 1.25rem);
            color: var(--muted);
            margin-top: 0.25rem;
        }

        .priority {
            padding: 0.35rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .priority-1 { background: var(--success); }
        .priority-2 { background: var(--warning); color: #000; }
        .priority-3 { background: #f97316; }
        .priority-4 { background: var(--danger); animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Info da ordem */
        .order-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: rgba(255,255,255,0.03);
            padding: 0.75rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .info-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 600;
        }

        .info-value.late {
            color: var(--danger);
        }

        /* Notas */
        .order-notes {
            background: rgba(13, 110, 253, 0.1);
            border-left: 3px solid var(--accent);
            padding: 0.75rem 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            max-height: 4rem;
            overflow-y: auto;
        }

        /* Swipe slider */
        .swipe-area {
            margin-top: auto;
            padding-top: 0.5rem;
        }

        .swipe-slider {
            position: relative;
            height: 60px;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-radius: 30px;
            border: 2px solid var(--success);
            overflow: hidden;
        }

        .swipe-track {
            position: absolute;
            inset: 0;
            width: 0%;
            background: linear-gradient(90deg, var(--success) 0%, #34d399 100%);
            border-radius: 30px;
            transition: width 0.1s ease-out;
        }

        .swipe-slider.completed .swipe-track {
            width: 100% !important;
            transition: width 0.3s ease-out;
        }

        .swipe-handle {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 52px;
            height: 52px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--success);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: left 0.1s ease-out;
            z-index: 10;
            touch-action: none;
        }

        .swipe-slider.completed .swipe-handle {
            background: var(--success);
            color: #fff;
        }

        .swipe-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            gap: 0.5rem;
        }

        .swipe-text i {
            animation: bounce 1.5s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        .swipe-slider.swiping .swipe-text,
        .swipe-slider.completed .swipe-text {
            opacity: 0;
        }

        .swipe-success {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            opacity: 0;
            pointer-events: none;
        }

        .swipe-slider.completed .swipe-success {
            opacity: 1;
        }

        /* Fila - apenas visível em ecrãs maiores */
        .queue {
            display: none;
            background: var(--surface);
            border-radius: 0.75rem;
            padding: 0.75rem;
            max-height: 30vh;
            overflow-y: auto;
        }

        .queue-header {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .queue-count {
            background: var(--accent);
            color: #fff;
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            font-size: 0.7rem;
        }

        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            background: rgba(255,255,255,0.02);
            border-left: 3px solid var(--muted);
            font-size: 0.85rem;
        }

        .queue-item.p-4 { border-left-color: var(--danger); }
        .queue-item.p-3 { border-left-color: #f97316; }
        .queue-item.p-2 { border-left-color: var(--warning); }

        /* Estado vazio */
        .empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            text-align: center;
            padding: 2rem;
        }

        .empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty h2 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .empty p {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Status bar */
        .status-bar {
            background: var(--surface);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--muted);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block;
            margin-right: 0.4rem;
        }

        .status-dot.offline {
            background: var(--danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--success);
            color: #fff;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            z-index: 1000;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Loader */
        .loader {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsivo - ecrãs médios e grandes */
        @media (min-width: 600px) {
            .header {
                padding: 1rem 1.5rem;
            }

            .station-name {
                font-size: 1.5rem;
            }

            .content {
                padding: 1.5rem;
                flex-direction: row;
            }

            .order-card {
                flex: 2;
            }

            .queue {
                display: flex;
                flex-direction: column;
                flex: 1;
                max-height: none;
            }

            .swipe-slider {
                height: 70px;
            }

            .swipe-handle {
                width: 62px;
                height: 62px;
            }
        }

        /* Ecrãs muito pequenos */
        @media (max-width: 360px) {
            .header {
                padding: 0.5rem 0.75rem;
            }

            .station-name {
                font-size: 1rem;
            }

            .clock {
                font-size: 1rem;
            }

            .content {
                padding: 0.75rem;
            }

            .order-card {
                padding: 1rem;
            }

            .order-info {
                gap: 0.5rem;
            }

            .info-item {
                padding: 0.5rem;
            }

            .swipe-slider {
                height: 50px;
            }

            .swipe-handle {
                width: 42px;
                height: 42px;
                top: 4px;
                left: 4px;
                font-size: 1rem;
            }
        }

        /* Landscape em ecrãs pequenos */
        @media (max-height: 500px) {
            .header {
                padding: 0.5rem 1rem;
            }

            .content {
                padding: 0.5rem 1rem;
                flex-direction: row;
                gap: 1rem;
            }

            .order-card {
                padding: 0.75rem 1rem;
            }

            .order-header {
                margin-bottom: 0.5rem;
            }

            .order-info {
                margin-bottom: 0.5rem;
            }

            .info-item {
                padding: 0.5rem;
            }

            .order-notes {
                display: none;
            }

            .queue {
                display: flex;
                flex-direction: column;
                flex: 1;
                max-height: none;
            }

            .status-bar {
                padding: 0.25rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <div class="loader">
            <div class="spinner"></div>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-msg">Concluído!</span>
    </div>

    <script>
        const estacaoId = window.location.pathname.split('/').pop();
        const API = '/api';

        let estacao = null;
        let ordens = [];
        let socket = null;
        let connected = false;
        let processing = false;
        let swipeHandler = null;

        const PRIO = { 1: 'Baixa', 2: 'Normal', 3: 'Alta', 4: 'Urgente' };

        // ========== SWIPE ==========
        class SwipeHandler {
            constructor(el, onComplete) {
                this.el = el;
                this.handle = el.querySelector('.swipe-handle');
                this.track = el.querySelector('.swipe-track');
                this.onComplete = onComplete;
                this.dragging = false;
                this.startX = 0;
                this.x = 0;
                this.maxX = 0;
                this.init();
            }

            init() {
                this.maxX = this.el.offsetWidth - this.handle.offsetWidth - 8;

                this.handle.addEventListener('touchstart', e => this.start(e.touches[0].clientX), { passive: true });
                document.addEventListener('touchmove', e => this.move(e.touches[0].clientX), { passive: true });
                document.addEventListener('touchend', () => this.end());

                this.handle.addEventListener('mousedown', e => this.start(e.clientX));
                document.addEventListener('mousemove', e => this.move(e.clientX));
                document.addEventListener('mouseup', () => this.end());
            }

            start(clientX) {
                if (processing) return;
                this.dragging = true;
                this.startX = clientX - this.x;
                this.el.classList.add('swiping');
            }

            move(clientX) {
                if (!this.dragging) return;
                this.x = Math.max(0, Math.min(clientX - this.startX, this.maxX));
                this.handle.style.left = (4 + this.x) + 'px';
                this.track.style.width = (this.x / this.maxX * 100) + '%';
            }

            end() {
                if (!this.dragging) return;
                this.dragging = false;
                this.el.classList.remove('swiping');

                if (this.x >= this.maxX * 0.9) {
                    this.complete();
                } else {
                    this.reset();
                }
            }

            complete() {
                this.el.classList.add('completed');
                this.handle.style.left = (4 + this.maxX) + 'px';
                this.track.style.width = '100%';
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                if (this.onComplete) this.onComplete();
            }

            reset() {
                this.x = 0;
                this.handle.style.left = '4px';
                this.track.style.width = '0%';
                this.el.classList.remove('completed');
            }
        }

        // ========== WEBSOCKET ==========
        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                connected = true;
                socket.emit('join-station', estacaoId);
                updateStatus();
            });

            socket.on('disconnect', () => {
                connected = false;
                updateStatus();
            });

            ['order-started', 'order-station-changed', 'order-completed', 'order-completed-station'].forEach(event => {
                socket.on(event, async (data) => {
                    await loadOrders();
                    render();
                    if (event === 'order-station-changed' && data.toStation == estacaoId) {
                        playSound(880, 200);
                    }
                });
            });
        }

        function updateStatus() {
            const dot = document.querySelector('.status-dot');
            if (dot) dot.classList.toggle('offline', !connected);
        }

        // ========== API ==========
        async function advanceOrder(id) {
            if (processing) return;
            processing = true;

            try {
                const res = await fetch(`${API}/ordens/${id}/avancar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estacao_id: estacaoId })
                });

                if (res.ok) {
                    showToast('Concluído!');
                    playSuccess();
                    setTimeout(async () => {
                        await loadOrders();
                        render();
                        processing = false;
                    }, 1500);
                } else {
                    const err = await res.json();
                    showToast(err.error || 'Erro', true);
                    if (swipeHandler) swipeHandler.reset();
                    processing = false;
                }
            } catch (e) {
                showToast('Erro de conexão', true);
                if (swipeHandler) swipeHandler.reset();
                processing = false;
            }
        }

        // ========== SOUNDS ==========
        function playSound(freq, dur) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => osc.stop(), dur);
            } catch (e) {}
        }

        function playSuccess() {
            playSound(523, 100);
            setTimeout(() => playSound(659, 100), 100);
            setTimeout(() => playSound(784, 150), 200);
        }

        // ========== TOAST ==========
        function showToast(msg, error = false) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.textContent = msg;
            toast.classList.toggle('error', error);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // ========== LOAD ==========
        async function loadStation() {
            try {
                const res = await fetch(`${API}/estacoes/${estacaoId}`);
                estacao = res.ok ? await res.json() : { nome: 'Estação', cor: '#0d6efd', icone: 'fa-cog' };
                document.documentElement.style.setProperty('--accent', estacao.cor || '#0d6efd');
            } catch (e) {
                estacao = { nome: 'Estação', cor: '#0d6efd', icone: 'fa-cog' };
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API}/estacoes/${estacaoId}/ordens`);
                ordens = res.ok ? await res.json() : [];
            } catch (e) {
                ordens = [];
            }
        }

        function formatDate(str) {
            if (!str) return '-';
            return new Date(str).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' });
        }

        function daysUntil(str) {
            if (!str) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const d = new Date(str);
            d.setHours(0, 0, 0, 0);
            return Math.ceil((d - today) / 86400000);
        }

        // ========== RENDER ==========
        function render() {
            const app = document.getElementById('app');
            const current = ordens.find(o => o.estado_estacao === 'em_progresso') || ordens[0];
            const queue = ordens.filter(o => o !== current);
            const now = new Date();

            app.innerHTML = `
                <header class="header">
                    <div class="station-name">
                        <i class="fas ${estacao.icone || 'fa-cog'}"></i>
                        <span>${estacao.nome}</span>
                    </div>
                    <div class="clock" id="clock">${now.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}</div>
                </header>

                <main class="content">
                    ${current ? renderOrder(current) : renderEmpty()}
                    ${renderQueue(queue)}
                </main>

                <footer class="status-bar">
                    <div>
                        <span class="status-dot ${connected ? '' : 'offline'}"></span>
                        ${connected ? 'Online' : 'Offline'}
                    </div>
                    <div>ProduFlow</div>
                </footer>
            `;

            if (current) {
                const swipeEl = document.getElementById('swipe');
                if (swipeEl) {
                    swipeHandler = new SwipeHandler(swipeEl, () => advanceOrder(current.id));
                }
            }
        }

        function renderOrder(o) {
            const days = daysUntil(o.data_prevista);
            const late = days !== null && days < 0;

            return `
                <div class="order-card has-order">
                    <div class="order-header">
                        <div>
                            <div class="order-id">${o.numero}</div>
                            <div class="order-product">${o.produto_nome}</div>
                        </div>
                        <div class="priority priority-${o.prioridade}">${PRIO[o.prioridade]}</div>
                    </div>

                    <div class="order-info">
                        <div class="info-item">
                            <div class="info-label">Qty</div>
                            <div class="info-value">${o.quantidade}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Cliente</div>
                            <div class="info-value" style="font-size: clamp(0.8rem, 2.5vw, 1rem);">${o.cliente_nome || o.cliente || '-'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Entrega</div>
                            <div class="info-value ${late ? 'late' : ''}">${formatDate(o.data_prevista)}</div>
                        </div>
                    </div>

                    ${o.notas ? `<div class="order-notes">${o.notas}</div>` : ''}

                    <div class="swipe-area">
                        <div class="swipe-slider" id="swipe">
                            <div class="swipe-track"></div>
                            <div class="swipe-handle"><i class="fas fa-chevron-right"></i></div>
                            <div class="swipe-text">Deslizar para concluir <i class="fas fa-arrow-right"></i></div>
                            <div class="swipe-success"><i class="fas fa-check"></i> Concluído</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmpty() {
            return `
                <div class="order-card">
                    <div class="empty">
                        <i class="fas fa-check-circle"></i>
                        <h2>Sem tarefas</h2>
                        <p>Não há ordens pendentes para esta estação.</p>
                    </div>
                </div>
            `;
        }

        function renderQueue(queue) {
            return `
                <div class="queue">
                    <div class="queue-header">
                        <span>Fila</span>
                        <span class="queue-count">${queue.length}</span>
                    </div>
                    ${queue.length === 0 ?
                        '<div style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.8rem;">Vazia</div>' :
                        queue.map(o => `
                            <div class="queue-item p-${o.prioridade}">
                                <span>${o.numero}</span>
                                <span style="color: var(--muted);">${o.quantidade}x</span>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        // ========== CLOCK ==========
        function updateClock() {
            const el = document.getElementById('clock');
            if (el) el.textContent = new Date().toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
        }

        // ========== INIT ==========
        async function init() {
            await loadStation();
            await loadOrders();
            render();
            initSocket();

            setInterval(updateClock, 1000);
            setInterval(async () => {
                if (!connected && !processing) {
                    await loadOrders();
                    render();
                }
            }, 30000);
        }

        init();
    </script>
</body>
</html>
